<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>꼬꼬너 - 꼬리에 꼬리를 물어 찾은 너</title>
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Socket.io -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff6f0f 0%, #ff8f3f 50%, #ffb347 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .floating-memory {
            position: absolute;
            opacity: 0.1;
            animation: float 20s infinite ease-in-out;
            font-size: 2rem;
        }

        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.1; }
            50% { opacity: 0.3; }
            90% { opacity: 0.1; }
        }

        .app-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: translateY(0);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh;
            overflow-y: auto;
        }

        .main-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
        }

        .app-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .app-title {
            font-size: 3rem;
            background: linear-gradient(135deg, #ff6f0f, #ff8f3f, #ffb347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            margin-bottom: 10px;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { filter: drop-shadow(0 0 5px rgba(255, 111, 15, 0.3)); }
            to { filter: drop-shadow(0 0 20px rgba(255, 143, 63, 0.6)); }
        }

        .app-subtitle {
            font-size: 1.3rem;
            color: #666;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .app-description {
            background: linear-gradient(135deg, rgba(255, 111, 15, 0.1), rgba(255, 179, 71, 0.1));
            border: 2px solid rgba(255, 111, 15, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            line-height: 1.6;
        }

        .app-description::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        /* 상담 실종아동 배너 추가 */
        .consultation-banner {
            background: linear-gradient(135deg, #ff6b35, #ff8f65);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            text-align: center;
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
            animation: pulse 2s infinite;
            display: none;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* 스텝 네비게이션 */
        .step-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
            max-width: 120px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step-item.active .step-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.1);
        }

        .step-item.completed .step-number {
            background: #4CAF50;
            color: white;
        }

        .step-label {
            font-size: 0.85rem;
            color: #666;
            text-align: center;
            font-weight: 500;
        }

        .step-item.active .step-label {
            color: #667eea;
            font-weight: 600;
        }

        .step-line {
            position: absolute;
            top: 20px;
            left: 60px;
            right: -60px;
            height: 2px;
            background: #e0e0e0;
            z-index: -1;
        }

        .step-item:last-child .step-line {
            display: none;
        }

        .step-item.completed .step-line {
            background: #4CAF50;
        }

        /* 진행률 표시 */
        .progress-container {
            margin: 20px 0;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: progressShine 2s infinite;
        }

        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* 로딩 상태 개선 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .loading-subtext {
            font-size: 0.9rem;
            color: #666;
        }

        /* 알림 메시지 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            border-left: 4px solid #4CAF50;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            border-left-color: #f44336;
        }

        .notification.warning {
            border-left-color: #ff9800;
        }

        /* 입력 필드 유효성 검사 */
        .form-input.invalid, .form-textarea.invalid {
            border-color: #f44336;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1);
        }

        .form-input.valid, .form-textarea.valid {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .field-error {
            color: #f44336;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        .field-error.show {
            display: block;
        }

        /* 애니메이션 개선 */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .slide-up {
            animation: slideUp 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .login-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .category-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .category-card {
            background: white;
            border: 3px solid transparent;
            border-radius: 20px;
            padding: 20px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: #667eea;
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.3);
        }

        .category-card:hover::before {
            opacity: 0.1;
        }

        .category-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            transform: scale(1.02);
        }

        .category-icon {
            font-size: 2rem;
            position: relative;
            z-index: 1;
        }

        .category-title {
            font-weight: 600;
            color: #333;
            position: relative;
            z-index: 1;
            font-size: 1.1rem;
        }

        .question-section {
            display: none;
            margin-top: 30px;
        }

        .question-section.active {
            display: block;
            animation: slideUp 0.6s ease-out;
        }

        .question-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .question-card.active {
            border-color: #667eea;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.2);
        }

        .question-subtitle {
            font-size: 1rem;
            background: linear-gradient(135deg, #ffeb3b, #ffc107);
            color: #b8860b;
            margin-bottom: 20px;
            font-weight: 600;
            padding: 12px 20px;
            border-radius: 12px;
            border: 2px solid #ffc107;
            text-align: center;
            box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-weight: 500;
        }

        .tag:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .tag.selected {
            background: linear-gradient(135deg, #ff6b35, #ff8f65);
            transform: scale(1.05);
        }

        .additional-input {
            margin-top: 10px;
        }

        .additional-input input {
            width: 100%;
            padding: 12px 15px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
        }

        .additional-input input:focus {
            border-color: #667eea;
            border-style: solid;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            margin: 5px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(108, 117, 125, 0.4);
        }

        .review-section {
            display: none;
            margin-top: 30px;
        }

        .review-section.active {
            display: block;
            animation: slideUp 0.6s ease-out;
        }

        .review-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #e0e0e0;
        }

        .review-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .review-question {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .review-answer {
            color: #666;
            font-size: 0.9rem;
            background: white;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .edit-btn {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
        }

        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);
        }

        .matching-results {
            display: none;
            margin-top: 30px;
        }

        .matching-results.active {
            display: block;
            animation: slideUp 0.6s ease-out;
        }

        .match-list {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .match-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            background: rgba(102, 126, 234, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .match-item:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .match-info {
            flex: 1;
        }

        .match-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .match-details {
            font-size: 0.9rem;
            color: #666;
        }

        .match-percentage {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .comparison-section {
            display: none;
            margin-top: 30px;
        }

        .comparison-section.active {
            display: block;
            animation: slideUp 0.6s ease-out;
        }

        .comparison-table {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .comparison-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .comparison-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .question-title {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
        }

        .answer-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .my-answer-section {
            text-align: center;
        }

        .partner-answer-section {
            text-align: center;
        }

        .answer-label {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .my-answer-label {
            color: #667eea;
        }

        .partner-answer-label {
            color: #ff6b35;
        }

        .answer-content {
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: 500;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.4;
        }

        .my-answer {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(102, 126, 234, 0.05));
            border: 2px solid rgba(102, 126, 234, 0.2);
            color: #333;
        }

        .partner-answer {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 107, 53, 0.05));
            border: 2px solid rgba(255, 107, 53, 0.2);
            color: #333;
        }

        .similar-match {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05));
            border: 2px solid rgba(76, 175, 80, 0.3);
        }

        .exact-match {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(33, 150, 243, 0.05));
            border: 2px solid rgba(33, 150, 243, 0.3);
        }

        .match-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .similar-indicator {
            background: #4CAF50;
            color: white;
        }

        .exact-indicator {
            background: #2196F3;
            color: white;
        }

        .chat-room {
            display: none;
        }

        .chat-room.active {
            display: block;
            animation: slideUp 0.6s ease-out;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            text-align: center;
            font-weight: 600;
        }

        .chat-messages {
            background: white;
            padding: 20px;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #667eea;
            border-top: none;
        }

        .chat-input-area {
            background: white;
            padding: 20px;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 15px 15px;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 70%;
            line-height: 1.4;
        }

        .message.sent {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.received {
            background: #f1f3f4;
            color: #333;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sparkle {
            animation: sparkle 2s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* 조건부 질문 숨김 */
        .conditional-question {
            display: none;
        }

        .conditional-question.show {
            display: block;
            animation: slideUp 0.6s ease-out;
        }

        /* 개인정보 보호 안내 스타일 */
        .privacy-notice {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px 25px;
            border-radius: 15px;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
            border: 2px solid rgba(76, 175, 80, 0.2);
            line-height: 1.5;
            animation: fadeInUp 0.8s ease-out;
        }

        .privacy-notice::before {
            content: '🔒';
            font-size: 1.5rem;
            margin-right: 10px;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 카카오 로그인 스타일 */
        .kakao-login-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .login-subtitle {
            font-size: 1rem;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .kakao-login-btn {
            background: #FEE500;
            color: #000;
            border: none;
            border-radius: 12px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(254, 229, 0, 0.3);
        }

        .kakao-login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(254, 229, 0, 0.4);
        }

        .kakao-icon {
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDNDNy4wMyAzIDMgNi4zNCAzIDEwLjVDMyAxMy4zIDUuNSAxNS42IDkgMTYuNUwxMSAyMUwxMyAxNi41QzE2LjUgMTUuNiAxOSAxMy4zIDE5IDEwLjVDMTkgNi4zNCAxNC45NyAzIDEyIDNaIiBmaWxsPSIjMDAwIi8+Cjwvc3ZnPgo=') no-repeat center;
            background-size: contain;
        }

        .user-info-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: none;
        }

        .user-profile {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #667eea;
        }

        .user-details h3 {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 5px;
        }

        .user-details p {
            color: #666;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #d32f2f;
        }

        /* 안내 문구 스타일 */
        .question-notice {
            background: rgba(255, 111, 15, 0.1);
            border: 1px solid rgba(255, 111, 15, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 8px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #d45500;
            line-height: 1.4;
        }

        /* 현재 카테고리 표시 바 */
        .current-category-bar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            animation: slideDown 0.5s ease-out;
        }

        .category-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .category-label {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .category-label::before {
            content: '📂';
            margin-right: 10px;
            font-size: 1.3rem;
        }

        .exit-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 8px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .exit-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }

            .main-card {
                padding: 20px;
                margin: 0;
                max-height: none;
                min-height: auto;
                width: 100%;
                max-width: 100%;
            }
            
            .app-title {
                font-size: 2rem;
                margin-bottom: 8px;
            }

            .answer-comparison {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .comparison-item {
                padding: 15px;
            }

            .question-title {
                font-size: 1rem;
                padding: 10px 15px;
            }

            .answer-content {
                padding: 12px 15px;
                min-height: 45px;
                font-size: 0.9rem;
            }

            .step-navigation {
                padding: 15px 10px;
            }

            .step-item {
                max-width: 80px;
            }

            .step-number {
                width: 30px;
                height: 30px;
                font-size: 0.8rem;
            }

            .step-label {
                font-size: 0.7rem;
            }

            .step-line {
                top: 15px;
                left: 40px;
                right: -40px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation" id="bgAnimation"></div>
    
    <!-- 로딩 오버레이 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">매칭을 시작하고 있습니다...</div>
            <div class="loading-subtext" id="loadingSubtext">잠시만 기다려주세요</div>
        </div>
    </div>

    <!-- 알림 메시지 -->
    <div class="notification" id="notification">
        <div id="notificationText">알림 메시지</div>
    </div>

    <div class="app-container">
        <div class="main-card">
            <div class="app-header">
                <h1 class="app-title sparkle">🔗 꼬꼬너</h1>
                <p class="app-subtitle">꼬리에 꼬리를 물어 찾은 너</p>
                <div class="app-description">
                    <strong>꼬꼬너는 룰 방식으로 당신의 기억을 더듬어서<br>
                    그리운 사람을 찾는 데 도움을 드립니다.</strong><br><br>
                    이름, 연락처, 사진 등 명확한 정보가 없어도<br>
                    어렴풋한 기억만으로 인연을 찾을 수 있는 새로운 방식의 플랫폼입니다.
                </div>
            </div>

            <!-- 실종아동 배너 -->
            <div class="consultation-banner" id="consultationBanner" onclick="goBackToCategory()" style="cursor: pointer;">
                🏥 실종아동
            </div>

            <!-- 스텝 네비게이션 -->
            <div class="step-navigation" id="stepNavigation" style="display: none;">
                <div class="step-item active" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-label">카테고리</div>
                    <div class="step-line"></div>
                </div>
                <div class="step-item" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-label">정보입력</div>
                    <div class="step-line"></div>
                </div>
                <div class="step-item" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-label">검토</div>
                    <div class="step-line"></div>
                </div>
                <div class="step-item" id="step4">
                    <div class="step-number">4</div>
                    <div class="step-label">매칭</div>
                    <div class="step-line"></div>
                </div>
                <div class="step-item" id="step5">
                    <div class="step-number">5</div>
                    <div class="step-label">연결</div>
                </div>
            </div>

            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <!-- 카카오 로그인 섹션 -->
            <div class="kakao-login-section" id="kakaoLoginSection">
                <h2 class="login-title">로그인이 필요합니다</h2>
                <p class="login-subtitle">
                    꼬꼬너 서비스를 이용하시려면<br>
                    카카오 계정으로 간편하게 로그인해주세요
                </p>
                <button class="kakao-login-btn" onclick="loginWithKakao()">
                    <div class="kakao-icon"></div>
                    카카오로 로그인
                </button>
            </div>

            <!-- 사용자 정보 섹션 -->
            <div class="user-info-section" id="userInfoSection">
                <div class="user-profile">
                    <img class="user-avatar" id="userAvatar" src="" alt="프로필">
                    <div class="user-details">
                        <h3 id="userName">사용자명</h3>
                        <p id="userEmail">이메일</p>
                    </div>
                </div>
                <button class="logout-btn" onclick="logoutKakao()">로그아웃</button>
            </div>

            <div class="login-section" id="loginSection" style="display: none;">
                <div class="privacy-notice">
                    꼬꼬너는 실명과 당신의 개인정보 보호를 위해서 주민번호를 수집하지 않습니다. 우리가 질문하는 기억 기반 내용을 성실하게 입력해 주세요.
                </div>
                <button class="btn btn-primary" onclick="startApp()">
                    카테고리를 선택해주세요
                </button>
                <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">베타 버전으로 간편하게 시작하세요</p>
            </div>

            <div class="category-section hidden" id="mainCategorySection">
                <h3 class="section-title">안녕하세요. 찾고 싶은 사람을 선택해주세요.</h3>
                <div class="category-grid">
                    <div class="category-card" onclick="selectMainCategory('missing')">
                        <span class="category-icon">👶</span>
                        <div class="category-title">실종아동(가족)</div>
                    </div>
                    
                    <div class="category-card" onclick="selectMainCategory('separated')">
                        <span class="category-icon">👴</span>
                        <div class="category-title">이산가족</div>
                    </div>
                    <div class="category-card" onclick="selectMainCategory('friends')">
                        <span class="category-icon">👥</span>
                        <div class="category-title">그리운친구</div>
                    </div>
                </div>
            </div>

            <!-- 현재 카테고리 표시 바 -->
            <div class="current-category-bar" id="currentCategoryBar" style="display: none;">
                <div class="category-info">
                    <span class="category-label" id="currentCategoryLabel">실종아동</span>
                    <button class="exit-btn" onclick="goBackToCategory()">나가기</button>
                </div>
            </div>

            <div class="question-section" id="questionSection">
                <div class="question-card active">
                    <p class="question-subtitle">사례 중에서 여러개 선택해도 되며 해당 사항이 없으면 빈칸에 입력해 주세요. 입력 자료가 많을 경우 반드시 쉼표로 구분해 주세요.</p>
                    
                    <div id="questionsContainer">
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-secondary" onclick="reviewAnswers()" id="reviewBtn">입력 내용 확인 및 수정</button>
                        <button class="btn btn-primary" onclick="startMatching()" id="startMatchingBtn">매칭 시작하기</button>
                    </div>
                </div>
            </div>

            <div class="review-section" id="reviewSection">
                <div class="review-card">
                    <h3 style="margin-bottom: 20px; color: #333; text-align: center;">입력하신 내용을 확인해주세요</h3>
                    <div id="reviewContent">
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="proceedToMatching()">수정 완료 - 매칭하기</button>
                        <button class="btn btn-secondary" onclick="goBackToQuestions()">더 수정하기</button>
                    </div>
                </div>
            </div>

            <div class="matching-results" id="matchingResults">
                <div class="match-list">
                    <h3 style="margin-bottom: 20px; color: #333;">매칭 결과</h3>
                    <div id="matchList">
                    </div>
                </div>
            </div>

            <div class="comparison-section" id="comparisonSection">
                <div class="comparison-table">
                    <h3 style="margin-bottom: 25px; color: #333; text-align: center; font-size: 1.3rem;">상세 비교 정보</h3>
                    <div id="comparisonContent">
                    </div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-primary" onclick="proceedToChat()">채팅방 입장하기</button>
                        <button class="btn btn-secondary" onclick="goBackToMatching()">다른 매칭 보기</button>
                    </div>
                </div>
            </div>

            <div class="chat-room" id="chatRoom">
                <div class="chat-header">
                    <h3 id="chatPartnerName">김○○님과의 대화</h3>
                    <div class="chat-status">
                        <span class="online-indicator"></span>
                        실시간 채팅
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="실시간으로 메시지를 입력하세요..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="send-btn" onclick="sendMessage()">전송</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentStep = 'login';
        let selectedCategory = '';
        let selectedSubCategory = '';
        let answers = {};
        let currentPartner = null;
        let currentUser = null;
        let socket = null;
        let currentChatRoom = null;

        // 이산가족 질문 데이터 (25개)
        const separatedFamilyQuestions = [
            {
                id: 'familyClan',
                question: '본관',
                type: 'text',
                placeholder: '예: 전주이씨, 김해김씨',
                notice: '전주이씨 식으로 써주세요.',
                required: true
            },
            {
                id: 'hometown',
                question: '나의 고향',
                type: 'text',
                placeholder: '예: 함경남도 흥남시',
                required: true
            },
            {
                id: 'myPhysicalFeatures',
                question: '나의 신체특징',
                type: 'textarea',
                placeholder: '키, 체형, 점, 흉터 등 신체적 특징을 자세히 적어주세요'
            },
            {
                id: 'familyPhysicalFeatures',
                question: '다른 가족의 신체특징',
                type: 'textarea',
                placeholder: '부모님, 형제자매의 신체적 특징을 기억나는 대로 적어주세요'
            },
            {
                id: 'relativeNames',
                question: '외가 친가 중 기억나는 이름 전부',
                type: 'textarea',
                placeholder: '할아버지, 할머니, 삼촌, 이모 등 친척들의 이름을 모두 적어주세요'
            },
            {
                id: 'relativeLocations',
                question: '외가 친가들 살던 동네',
                type: 'textarea',
                placeholder: '친척들이 살던 지역이나 동네를 기억나는 대로 적어주세요'
            },
            {
                id: 'separationYear',
                question: '헤어진 년도',
                type: 'text',
                placeholder: '예: 1950년, 1951년',
                required: true
            },
            {
                id: 'separationAge',
                question: '헤어질 때 나이',
                type: 'text',
                placeholder: '예: 15살, 20세',
                notice: '나이나 태어난 해는 정확하지 않아도 됩니다. 앞뒤 1년을 포함해서 3년 범위로 매칭 들어갑니다.',
                required: true
            },
            {
                id: 'separationReason',
                question: '헤어지게 된 이유',
                type: 'textarea',
                placeholder: '전쟁, 피난, 월남 등 헤어지게 된 구체적인 상황을 적어주세요'
            },
            {
                id: 'separationPlace',
                question: '헤어진 장소',
                type: 'text',
                placeholder: '예: 서울역, 부산항, 인천항'
            },
            {
                id: 'parentsJob',
                question: '부모 직업',
                type: 'text',
                placeholder: '예: 아버지-농업, 어머니-주부'
            },
            {
                id: 'familyMotto',
                question: '가훈',
                type: 'text',
                placeholder: '집안의 가훈이나 대대로 내려오는 말씀'
            },
            {
                id: 'familyIncidents',
                question: '교통사고 도둑 등 집안에 큰일 기억나는 것',
                type: 'textarea',
                placeholder: '집안에 일어났던 큰 사건이나 사고를 기억나는 대로 적어주세요'
            },
            {
                id: 'hospitalName',
                question: '잘 가던 병원 이름',
                type: 'text',
                placeholder: '예: 제중원, 세브란스병원'
            },
            {
                id: 'restaurantName',
                question: '잘 가던 식당 이름',
                type: 'text',
                placeholder: '자주 가던 식당이나 음식점 이름'
            },
            {
                id: 'touristSpots',
                question: '함께 놀러갔던 바다 또는 명승지',
                type: 'text',
                placeholder: '예: 해운대, 금강산, 백두산'
            },
            {
                id: 'deceasedRelativeIllness',
                question: '친척 중 돌아가신 분의 병명',
                type: 'text',
                placeholder: '예: 할아버지-폐렴, 삼촌-결핵'
            },
            {
                id: 'neighborFriends',
                question: '동네친구들 이름과 별명 전부',
                type: 'textarea',
                placeholder: '어릴 때 같이 놀던 동네 친구들의 이름과 별명을 모두 적어주세요'
            },
            {
                id: 'departurePeriod',
                question: '고향 떠난 시기',
                type: 'tags',
                options: ['해방전', '해방직후', '6.25 발발', '6.25 중', '1.4후퇴', '피난시기', '정전협정후', '1960년대', '1970년대', '1980년대', '1990년대', '2000년대', '2010년대', '2020년대', '기타시기']
            },
            {
                id: 'northKoreaLocation',
                question: '북한 고향 구체적 지명',
                type: 'text',
                placeholder: '예: 함경남도 흥남시 송평동',
                required: true
            },
            {
                id: 'leftBehindFamily',
                question: '북한에 남은 가족/친척',
                type: 'tags',
                options: ['부모님', '형제', '자매', '할아버지', '할머니', '외할아버지', '외할머니', '삼촌', '이모', '고모', '외삼촌', '사촌', '조카', '자녀', '배우자']
            },
            {
                id: 'firstSettlement',
                question: '남한 첫 정착지',
                type: 'text',
                placeholder: '예: 부산시 영도구, 서울시 용산구',
                required: true
            },
            {
                id: 'refugeeExperience',
                question: '피난민으로서의 경험',
                type: 'textarea',
                placeholder: '피난 과정에서 겪었던 일들, 정착 과정의 어려움 등을 자유롭게 적어주세요'
            },
            {
                id: 'northKoreaMemories',
                question: '북한에서의 기억',
                type: 'textarea',
                placeholder: '북한에서 살았을 때의 생활, 풍경, 사람들에 대한 기억을 자유롭게 적어주세요'
            },
            {
                id: 'familyTraditions',
                question: '집안 전통/관습',
                type: 'textarea',
                placeholder: '집안에서 지켜오던 전통이나 관습, 제사 방법 등을 적어주세요'
            },
            {
                id: 'searchAttempts',
                question: '이산가족 찾기 시도 방법',
                type: 'tags',
                options: ['적십자사', 'KBS이산가족찾기', 'MBC이산가족찾기', '신문광고', '방송출연', '인터넷검색', '정부기관', '교회', '절', '향우회', '동창회', '친척소개', '지인소개', '개인탐정', '기타방법']
            }
        ];

        // 실종아동 질문 데이터 (기존 29개 질문)
        const missingChildQuestions = [
            {
                id: 'targetRelation',
                question: '당신이 찾고자하는 상대방은 누구인가요?',
                type: 'tags',
                options: ['아들', '딸', '조카', '부모님', '형제', '자매', '할아버지', '할머니', '외할아버지', '외할머니', '삼촌', '이모', '고모', '외삼촌', '기타가족'],
                required: true
            },
            {
                id: 'separationAge',
                question: '당신이 가족과 헤어진 때가 몇살 때인가요?',
                type: 'text',
                placeholder: '예: 5살, 7세',
                required: true,
                notice: '나이나 태어난 해는 정확하지 않아도 됩니다. 앞뒤 1년을 포함해서 3년 범위로 매칭 들어갑니다.'
            },
            {
                id: 'houseType',
                question: '살던 집의 형태는?',
                type: 'tags',
                options: ['한옥', '양옥', '다세대', '연립', '아파트', '단독주택', '빌라', '상가주택', '전원주택']
            },
            {
                id: 'doorColor',
                question: '집의 대문 색깔은?',
                type: 'tags',
                options: ['파란색', '초록색', '갈색', '회색', '빨간색', '흰색', '검은색', '노란색', '분홍색', '보라색', '주황색', '나무색']
            },
            {
                id: 'floorLevel',
                question: '몇층에 살았는지?',
                type: 'text',
                placeholder: '예: 1층, 2층, 3층'
            },
            {
                id: 'doorMaterial',
                question: '집대문이 나무인지 철제문인지?',
                type: 'tags',
                options: ['나무', '철제문', '알루미늄', '유리문', '기타재질']
            },
            {
                id: 'frontStairs',
                question: '집 앞에 계단이 있었는지?',
                type: 'text',
                placeholder: '예: 3개 계단 있음, 계단 없음'
            },
            {
                id: 'nearbyFacilities1',
                question: '집 근처에 있던 시설들 (우물, 놀이터, 공원 등)',
                type: 'tags',
                options: ['우물', '놀이터', '공원', '연못', '시장', '상점', '학교', '병원', '교회', '절', '마을회관', '경찰서', '소방서']
            },
            {
                id: 'nearbyTransport',
                question: '집 근처 교통시설 (지하철, 기차역, 버스정류소)',
                type: 'tags',
                options: ['지하철', '기차역', '버스정류소', '택시정류장', '고속도로', '국도', '큰길', '작은길']
            },
            {
                id: 'religiousItems',
                question: '집에 십자가 또는 불교 물건이 있었나요?',
                type: 'tags',
                options: ['십자가', '불상', '성경', '불경', '기도실', '제단', '종교물품없음']
            },
            {
                id: 'yardItems',
                question: '마당에 있던 것들은?',
                type: 'tags',
                options: ['장독대', '우물', '나무', '화단', '텃밭', '강아지집', '닭장', '창고', '평상', '그네', '빨래터', '화장실']
            },
            {
                id: 'farmingCrops',
                question: '텃밭에서 농작물을 키웠는지?',
                type: 'text',
                placeholder: '예: 고추, 배추, 상추 등'
            },
            {
                id: 'relativeHouse',
                question: '자주 놀러가던 친척집은?',
                type: 'tags',
                options: ['할아버지댁', '외가댁', '삼촌', '고모', '이모', '외삼촌', '큰아버지', '작은아버지', '친척없음']
            },
            {
                id: 'relativeHouseFeatures',
                question: '친척집의 특징은?',
                type: 'tags',
                options: ['마당', '그네', '동물', '연못', '과수원', '밭', '산', '강', '바다근처', '시골', '도시']
            },
            {
                id: 'desiredToys',
                question: '사달라고 졸랐던(받았던) 장난감은?',
                type: 'text',
                placeholder: '예: 자전거, 인형, 로봇, 공'
            },
            {
                id: 'christmasGifts',
                question: '크리스마스 때 준(받은) 선물은?',
                type: 'text',
                placeholder: '예: 빨간색 자전거, 곰인형, 게임기'
            },
            {
                id: 'memorableGifts',
                question: '기타 기억에 남는 선물은?',
                type: 'text',
                placeholder: '예: 생일선물, 명절선물 등'
            },
            {
                id: 'memorableTrips',
                question: '기억에 남은 여행은?',
                type: 'text',
                placeholder: '예: 바닷가, 할머니집, 유원지, 산'
            },
            {
                id: 'scoldingMemory',
                question: '크게 혼난(야단친) 기억은?',
                type: 'textarea',
                placeholder: '무엇 때문에 혼났는지, 어떻게 혼났는지'
            },
            {
                id: 'praiseMemory',
                question: '크게 칭찬한(받은) 기억은?',
                type: 'textarea',
                placeholder: '무엇 때문에 칭찬받았는지'
            },
            {
                id: 'familyPhysicalFeatures',
                question: '부모 형제들의 신체 특징 (점, 문신, 불구)',
                type: 'textarea',
                placeholder: '예: 아버지 왼쪽 어깨에 점, 어머니 다리 절뚝'
            },
            {
                id: 'familyIllness',
                question: '가족 중 아팠던 분과 병명은?',
                type: 'textarea',
                placeholder: '예: 할머니가 당뇨병으로 아프셨음'
            },
            {
                id: 'deceasedRelatives',
                question: '사망한 친척, 이웃은?',
                type: 'text',
                placeholder: '예: 할아버지, 이웃 할머니'
            },
            {
                id: 'parentsCooking',
                question: '부모님이 잘해주신 음식은?',
                type: 'tags',
                options: ['김치찌개', '된장찌개', '미역국', '불고기', '갈비', '생선구이', '계란후라이', '볶음밥', '국수', '만두', '떡국', '잔치국수']
            },
            {
                id: 'snackFoods',
                question: '자주 했던 군것질은?',
                type: 'tags',
                options: ['사탕', '과자', '떡볶이', '순대', '어묵', '붕어빵', '호떡', '군고구마', '군밤', '아이스크림', '음료수', '껌']
            },
            {
                id: 'familyDining',
                question: '가족들과 같이 먹었던 외식은?',
                type: 'tags',
                options: ['짜장면', '짬뽕', '냉면', '갈비', '불고기', '치킨', '피자', '햄버거', '중국집', '한정식', '칼국수', '설렁탕']
            },
            {
                id: 'neighborFriendNames',
                question: '동네 친구 이름과 별명은?',
                type: 'text',
                placeholder: '예: 철수, 영희, 호돌이'
            },
            {
                id: 'friendFatherJob',
                question: '동네 친구의 아버지 직업은?',
                type: 'tags',
                options: ['생선가게', '구멍가게', '슈퍼', '식당', '이발소', '세탁소', '약국', '문방구', '정육점', '과일가게', '빵집', '카페', '철물점']
            },
            {
                id: 'friendSiblings',
                question: '친구 형제 남매의 이름과 별명은?',
                type: 'text',
                placeholder: '예: 철수 형, 영희 누나'
            },
            {
                id: 'otherMemories',
                question: '기타 기억하고 있는 모든 것',
                type: 'textarea',
                placeholder: '작은 기억들이라도 모두 적어주세요. 냄새, 소리, 느낌, 동네 특징 등 무엇이든...'
            }
        ];

        // 새로운 그리운친구 통합 질문 데이터 (22개)
        const friendQuestions = [
            {
                id: 'friendType',
                question: '찾고 싶은 친구는 누구인가요?',
                type: 'tags',
                options: ['동네친구', '유치원', '초등학교', '중학교', '고등학교', '대학교', '대학원', '군대친구', '직장친구'],
                required: true
            },
            {
                id: 'nickname',
                question: '본인의 별명 또는 닉네임',
                type: 'text',
                placeholder: '꼬꼬너는 개인정보 보호를 위해 실명으로 하지 않으며 기억 기반으로 충분히 찾을 수 있어요.',
                notice: '개인정보 보호를 위해 실명이 아닌 별명을 입력해주세요.'
            },
            {
                id: 'gender',
                question: '찾고싶은 상대방는 동성인가요, 이성인가요?',
                type: 'tags',
                options: ['동성', '이성'],
                required: true
            },
            {
                id: 'school',
                question: '상대방과 같은 학교였나요? 다른 학교라면 당신의 학교와 상대방의 학교를 적어주세요.',
                type: 'text',
                placeholder: '예: 같은 학교, 나-서울고 상대방-부산고'
            },
            {
                id: 'firstMet',
                question: '상대방은 처음 어디서 만났나요?',
                type: 'text',
                placeholder: '예: 학교 운동장, 동네 놀이터, 군부대 생활관'
            },
            {
                id: 'ageWhenMet',
                question: '상대방을 몇살(몇학년) 때 만났나요?',
                type: 'text',
                placeholder: '예: 15살, 고등학교 1학년'
            },
            {
                id: 'major',
                question: '대학교 친구라면 당신과 상대방의 전공과목을 써주세요.',
                type: 'text',
                placeholder: '예: 나-경영학과, 상대방-컴퓨터공학과',
                conditional: true,
                dependsOn: 'friendType',
                showWhen: ['대학교', '대학원']
            },
            {
                id: 'memorableEvent',
                question: '친구와 기억에 남는 해프닝',
                type: 'textarea',
                placeholder: '함께 겪었던 재미있거나 기억에 남는 일들을 적어주세요'
            },
            {
                id: 'myNeighborhood',
                question: '당신이 살던 동네',
                type: 'text',
                placeholder: '예: 서울시 강남구 역삼동'
            },
            {
                id: 'friendNeighborhood',
                question: '친구가 살던 동네',
                type: 'text',
                placeholder: '예: 서울시 송파구 잠실동'
            },
            {
                id: 'myParentsJob',
                question: '당신 부모님의 직업',
                type: 'text',
                placeholder: '예: 아버지-회사원, 어머니-간호사'
            },
            {
                id: 'friendParentsJob',
                question: '친구 부모님의 직업',
                type: 'text',
                placeholder: '예: 아버지-교사, 어머니-주부'
            },
            {
                id: 'helpMemory',
                question: '어려움과 곤경에서 서로 도와준 일',
                type: 'textarea',
                placeholder: '서로 도움을 주고받았던 기억들을 적어주세요'
            },
            {
                id: 'schoolTrip',
                question: '같은 학교라면 수학여행 어디로 갔나요? (다른 학교라면 비워두세요)',
                type: 'text',
                placeholder: '예: 제주도, 경주, 부산',
                conditional: true,
                dependsOn: 'school',
                showWhen: '같은 학교'
            },
            {
                id: 'schoolTripMemory',
                question: '수학여행에서 추억이 남는 일',
                type: 'textarea',
                placeholder: '수학여행에서 있었던 기억에 남는 일들',
                conditional: true,
                dependsOn: 'schoolTrip'
            },
            {
                id: 'teacherNames',
                question: '담임선생님, 교수, 학과장 이름 기억나는대로 모두 쓰세요.',
                type: 'text',
                placeholder: '예: 김철수 선생님, 박영희 교수님'
            },
            {
                id: 'subjectTeachers',
                question: '각 과목별 선생님 이름과 별명',
                type: 'textarea',
                placeholder: '예: 수학-김선생님(곰선생), 영어-이선생님(까마귀)'
            },
            {
                id: 'gradeClass',
                question: '학년과 반',
                type: 'text',
                placeholder: '예: 2학년 3반'
            },
            {
                id: 'mySiblings',
                question: '본인 몇남몇녀 중 몇째',
                type: 'text',
                placeholder: '예: 2남 1녀 중 둘째'
            },
            {
                id: 'friendSiblings',
                question: '친구 몇남몇녀 중 몇째',
                type: 'text',
                placeholder: '예: 1남 2녀 중 막내'
            },
            {
                id: 'scholarship',
                question: '장학금 받은 경험',
                type: 'text',
                placeholder: '예: 성적우수 장학금, 근로 장학금'
            },
            {
                id: 'otherDetails',
                question: '기타 기술하고 싶은 내용 쓰세요.',
                type: 'textarea',
                placeholder: '위에서 다루지 못한 모든 기억들을 자유롭게 적어주세요'
            }
        ];

        // 샘플 답변 데이터
        const sampleAnswers = {
            missing: {
                targetRelation: ['딸'],
                separationAge: '7살',
                doorColor: ['파란색'],
                houseType: ['단독주택'],
                frontStairs: '3개',
                nearbyFacilities1: ['상점', '우물'],
                yardItems: ['장독대', '나무'],
                religiousItems: ['십자가'],
                farmingCrops: '고추, 배추'
            },
            separated: {
                familyClan: '전주이씨',
                hometown: '함경남도 흥남시',
                separationYear: '1950년',
                separationAge: '20살',
                departurePeriod: ['6.25 발발'],
                northKoreaLocation: '함경남도 흥남시 송평동',
                firstSettlement: '부산시 영도구'
            },
            friends: {
                friendType: ['고등학교'],
                nickname: '철이',
                gender: ['동성'],
                school: '같은 학교',
                myNeighborhood: '서울시 강남구',
                friendNeighborhood: '서울시 송파구',
                memorableEvent: '체육대회에서 같이 달리기를 했던 기억이 나요'
            }
        };

        // Firebase 및 소켓 초기화 함수들
        function initFirebase() {
            console.log('Firebase 초기화 (데모 모드)');
        }

        function initSocket() {
            console.log('Socket.io 초기화 (데모 모드)');
        }

        // 카카오 SDK 초기화
        function initKakao() {
            if (window.Kakao) {
                Kakao.init('YOUR_KAKAO_APP_KEY');
                console.log('카카오 SDK 초기화 완료');
                checkLoginStatus();
            }
        }

        // 로그인 상태 확인
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('kkokko_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showUserInfo();
            } else {
                showKakaoLogin();
            }
        }

        // 카카오 로그인
        function loginWithKakao() {
            const demoUser = {
                id: 'demo_user_' + Date.now(),
                nickname: '꼬꼬너 사용자',
                profile_image: 'https://via.placeholder.com/60?text=😊',
                email: 'demo@kkokko.com'
            };
            
            currentUser = demoUser;
            localStorage.setItem('kkokko_user', JSON.stringify(demoUser));
            showUserInfo();
            showNotification('로그인되었습니다! 환영합니다.', 'success');
        }

        // 사용자 정보 표시
        function showUserInfo() {
            document.getElementById('kakaoLoginSection').style.display = 'none';
            document.getElementById('userInfoSection').style.display = 'block';
            document.getElementById('loginSection').style.display = 'block';
            
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.nickname;
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('userAvatar').src = currentUser.profile_image;
            }
        }

        // 카카오 로그인 화면 표시
        function showKakaoLogin() {
            document.getElementById('kakaoLoginSection').style.display = 'block';
            document.getElementById('userInfoSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'none';
        }

        // 로그아웃
        function logoutKakao() {
            currentUser = null;
            localStorage.removeItem('kkokko_user');
            showKakaoLogin();
            showNotification('로그아웃되었습니다.', 'success');
            resetApp();
        }

        // 앱 상태 초기화
        function resetApp() {
            currentStep = 'login';
            selectedCategory = '';
            selectedSubCategory = '';
            answers = {};
            currentPartner = null;
            
            document.querySelectorAll('.category-section, .question-section, .review-section, .matching-results, .comparison-section, .chat-room').forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('active');
            });
            
            document.getElementById('stepNavigation').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('consultationBanner').style.display = 'none';
        }

        // UX 개선 함수들
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showLoading(text = '처리중...', subtext = '잠시만 기다려주세요') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            
            loadingText.textContent = text;
            loadingSubtext.textContent = subtext;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function updateStepNavigation(currentStepNum) {
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                if (i < currentStepNum) {
                    step.className = 'step-item completed';
                } else if (i === currentStepNum) {
                    step.className = 'step-item active';
                } else {
                    step.className = 'step-item';
                }
            }
        }

        function updateProgress(percentage) {
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        // 핵심 함수들
        function startApp() {
            if (!currentUser) {
                showNotification('로그인이 필요합니다.', 'warning');
                return;
            }
            
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainCategorySection').classList.remove('hidden');
            document.getElementById('stepNavigation').style.display = 'flex';
            document.getElementById('progressContainer').style.display = 'block';
            
            updateStepNavigation(1);
            updateProgress(20);
            currentStep = 'category';
            
            showNotification('시작합니다! 카테고리를 선택해주세요.', 'success');
        }

        function selectMainCategory(category) {
            selectedCategory = category;
            
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.target.closest('.category-card').classList.add('selected');
            
            if (category === 'missing') {
                selectedSubCategory = 'child';
                document.getElementById('consultationBanner').style.display = 'block';
                setTimeout(() => {
                    startQuestions();
                }, 500);
            } else if (category === 'separated') {
                // 이산가족은 바로 설문으로
                selectedSubCategory = 'family';
                setTimeout(() => {
                    startQuestions();
                }, 500);
            } else if (category === 'friends') {
                // 그리운친구는 바로 설문으로 (서브카테고리 제거됨)
                selectedSubCategory = 'unified';
                setTimeout(() => {
                    startQuestions();
                }, 500);
            }
            
            updateProgress(40);
            showNotification('카테고리가 선택되었습니다!', 'success');
        }

        function startQuestions() {
            document.getElementById('mainCategorySection').classList.add('hidden');
            document.getElementById('questionSection').classList.add('active');
            document.getElementById('currentCategoryBar').style.display = 'block';
            
            // 카테고리 라벨 업데이트
            updateCategoryLabel();
            
            updateStepNavigation(2);
            
            if (selectedCategory === 'missing') {
                loadMissingChildQuestions();
            } else if (selectedCategory === 'separated') {
                loadSeparatedFamilyQuestions();
            } else if (selectedCategory === 'friends') {
                loadFriendQuestions();
            }
            
            updateProgress(60);
            showNotification('이제 정보를 입력해주세요!', 'success');
        }

        function updateCategoryLabel() {
            const categoryNames = {
                'missing': '실종아동(가족)',
                'separated': '이산가족', 
                'friends': '그리운친구'
            };
            
            const label = document.getElementById('currentCategoryLabel');
            label.textContent = categoryNames[selectedCategory] || '카테고리';
        }

        function loadMissingChildQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            missingChildQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'form-group fade-in';
                questionDiv.style.animationDelay = `${index * 0.1}s`;
                
                let inputHTML = '';
                if (q.type === 'text') {
                    inputHTML = `
                        <input type="text" class="form-input" id="${q.id}" placeholder="${q.placeholder}" ${q.required ? 'data-required="true"' : ''}>
                        <div class="field-error">필수 입력 항목입니다.</div>
                    `;
                } else if (q.type === 'textarea') {
                    inputHTML = `
                        <textarea class="form-textarea" id="${q.id}" placeholder="${q.placeholder}" ${q.required ? 'data-required="true"' : ''}></textarea>
                        <div class="field-error">필수 입력 항목입니다.</div>
                    `;
                } else if (q.type === 'tags') {
                    inputHTML = `
                        <div class="tag-container">
                            ${q.options.map(option => `<button class="tag" onclick="toggleTag(this, '${q.id}', '${option}')">${option}</button>`).join('')}
                        </div>
                        <div class="additional-input">
                            <input type="text" placeholder="기타 입력 (쉼표로 구분)" id="${q.id}_additional">
                        </div>
                    `;
                }
                
                questionDiv.innerHTML = `
                    <label class="form-label">
                        ${q.question}
                        ${q.required ? '<span style="color: #f44336;">*</span>' : ''}
                    </label>
                    ${q.notice ? `<div class="question-notice">${q.notice}</div>` : ''}
                    ${inputHTML}
                `;
                
                container.appendChild(questionDiv);
            });
            
            addValidationListeners();
        }

        function loadSeparatedFamilyQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            // 안내문 추가
            const noticeDiv = document.createElement('div');
            noticeDiv.className = 'question-notice';
            noticeDiv.style.marginBottom = '25px';
            noticeDiv.style.padding = '20px';
            noticeDiv.style.fontSize = '1rem';
            noticeDiv.style.fontWeight = '600';
            noticeDiv.innerHTML = '안내문: 이곳은 한국전쟁 때 월남한 당신이 기억 기반으로 작성합니다.';
            container.appendChild(noticeDiv);
            
            separatedFamilyQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'form-group fade-in';
                questionDiv.style.animationDelay = `${index * 0.1}s`;
                
                let inputHTML = '';
                if (q.type === 'text') {
                    inputHTML = `
                        <input type="text" class="form-input" id="${q.id}" placeholder="${q.placeholder}" ${q.required ? 'data-required="true"' : ''}>
                        <div class="field-error">필수 입력 항목입니다.</div>
                    `;
                } else if (q.type === 'textarea') {
                    inputHTML = `
                        <textarea class="form-textarea" id="${q.id}" placeholder="${q.placeholder}" ${q.required ? 'data-required="true"' : ''}></textarea>
                        <div class="field-error">필수 입력 항목입니다.</div>
                    `;
                } else if (q.type === 'tags') {
                    inputHTML = `
                        <div class="tag-container">
                            ${q.options.map(option => `<button class="tag" onclick="toggleTag(this, '${q.id}', '${option}')">${option}</button>`).join('')}
                        </div>
                        <div class="additional-input">
                            <input type="text" placeholder="기타 입력 (쉼표로 구분)" id="${q.id}_additional">
                        </div>
                    `;
                }
                
                questionDiv.innerHTML = `
                    <label class="form-label">
                        ${q.question}
                        ${q.required ? '<span style="color: #f44336;">*</span>' : ''}
                    </label>
                    ${q.notice ? `<div class="question-notice">${q.notice}</div>` : ''}
                    ${inputHTML}
                `;
                
                container.appendChild(questionDiv);
            });
            
            addValidationListeners();
        }

        function loadFriendQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            friendQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = `form-group fade-in ${q.conditional ? 'conditional-question' : ''}`;
                questionDiv.style.animationDelay = `${index * 0.1}s`;
                questionDiv.id = `question_${q.id}`;
                
                let inputHTML = '';
                if (q.type === 'text') {
                    inputHTML = `
                        <input type="text" class="form-input" id="${q.id}" placeholder="${q.placeholder}" ${q.required ? 'data-required="true"' : ''} onchange="checkConditionalQuestions()">
                        <div class="field-error">필수 입력 항목입니다.</div>
                    `;
                } else if (q.type === 'textarea') {
                    inputHTML = `
                        <textarea class="form-textarea" id="${q.id}" placeholder="${q.placeholder}" ${q.required ? 'data-required="true"' : ''}></textarea>
                        <div class="field-error">필수 입력 항목입니다.</div>
                    `;
                } else if (q.type === 'tags') {
                    inputHTML = `
                        <div class="tag-container">
                            ${q.options.map(option => `<button class="tag" onclick="toggleTag(this, '${q.id}', '${option}'); checkConditionalQuestions();">${option}</button>`).join('')}
                        </div>
                        <div class="additional-input">
                            <input type="text" placeholder="기타 입력 (쉼표로 구분)" id="${q.id}_additional">
                        </div>
                    `;
                }
                
                questionDiv.innerHTML = `
                    <label class="form-label">
                        ${q.question}
                        ${q.required ? '<span style="color: #f44336;">*</span>' : ''}
                    </label>
                    ${q.notice ? `<div class="question-notice">${q.notice}</div>` : ''}
                    ${inputHTML}
                `;
                
                // 조건부 질문 초기 상태 설정
                if (q.conditional) {
                    questionDiv.style.display = 'none';
                }
                
                container.appendChild(questionDiv);
            });
            
            addValidationListeners();
            checkConditionalQuestions(); // 초기 로드 시 조건부 질문 체크
        }

        // 조건부 질문 표시/숨김 처리
        function checkConditionalQuestions() {
            friendQuestions.forEach(q => {
                if (q.conditional) {
                    const questionElement = document.getElementById(`question_${q.id}`);
                    const dependsOnValue = getAnswerValue(q.dependsOn);
                    
                    let shouldShow = false;
                    
                    if (q.dependsOn === 'friendType' && Array.isArray(q.showWhen)) {
                        // friendType의 경우 배열로 답변이 저장됨
                        shouldShow = q.showWhen.some(condition => 
                            Array.isArray(dependsOnValue) ? dependsOnValue.includes(condition) : dependsOnValue === condition
                        );
                    } else if (q.dependsOn === 'school' && q.showWhen === '같은 학교') {
                        // school 필드에 '같은 학교'가 포함되어 있는지 확인
                        shouldShow = dependsOnValue && dependsOnValue.includes('같은 학교');
                    } else if (q.dependsOn === 'schoolTrip') {
                        // schoolTrip에 값이 있으면 수학여행 추억 질문 표시
                        shouldShow = dependsOnValue && dependsOnValue.trim() !== '';
                    }
                    
                    if (shouldShow) {
                        questionElement.style.display = 'block';
                        questionElement.classList.add('show');
                    } else {
                        questionElement.style.display = 'none';
                        questionElement.classList.remove('show');
                        // 숨겨진 질문의 답변 초기화
                        clearQuestionAnswer(q.id);
                    }
                }
            });
        }

        // 답변 값 가져오기
        function getAnswerValue(questionId) {
            const element = document.getElementById(questionId);
            if (!element) return null;
            
            if (element.type === 'text' || element.tagName === 'TEXTAREA') {
                return element.value.trim();
            }
            
            // tags 타입의 경우 answers 객체에서 가져오기
            return answers[questionId] || null;
        }

        // 질문 답변 초기화
        function clearQuestionAnswer(questionId) {
            const element = document.getElementById(questionId);
            if (element) {
                if (element.type === 'text' || element.tagName === 'TEXTAREA') {
                    element.value = '';
                }
            }
            
            // tags 선택 초기화
            const tags = document.querySelectorAll(`#question_${questionId} .tag.selected`);
            tags.forEach(tag => tag.classList.remove('selected'));
            
            // answers 객체에서도 제거
            delete answers[questionId];
        }

        function addValidationListeners() {
            document.querySelectorAll('.form-input, .form-textarea').forEach(input => {
                input.addEventListener('blur', () => validateInput(input));
                input.addEventListener('input', () => {
                    if (input.classList.contains('invalid')) {
                        validateInput(input);
                    }
                });
            });
        }

        function validateInput(input) {
            const value = input.value.trim();
            const isRequired = input.hasAttribute('data-required');
            const fieldError = input.nextElementSibling;
            
            if (isRequired && !value) {
                input.classList.add('invalid');
                input.classList.remove('valid');
                if (fieldError && fieldError.classList.contains('field-error')) {
                    fieldError.textContent = '필수 입력 항목입니다.';
                    fieldError.classList.add('show');
                }
                return false;
            } else if (value) {
                input.classList.add('valid');
                input.classList.remove('invalid');
                if (fieldError && fieldError.classList.contains('field-error')) {
                    fieldError.classList.remove('show');
                }
                return true;
            } else {
                input.classList.remove('invalid', 'valid');
                if (fieldError && fieldError.classList.contains('field-error')) {
                    fieldError.classList.remove('show');
                }
                return true;
            }
        }

        function toggleTag(element, questionId, value) {
            element.classList.toggle('selected');
            
            if (!answers[questionId]) {
                answers[questionId] = [];
            }
            
            const index = answers[questionId].indexOf(value);
            if (index > -1) {
                answers[questionId].splice(index, 1);
            } else {
                answers[questionId].push(value);
            }
            
            element.style.transform = 'scale(0.95)';
            setTimeout(() => {
                element.style.transform = '';
            }, 150);
        }

        function collectAllAnswers() {
            document.querySelectorAll('.form-input, .form-textarea').forEach(input => {
                if (input.value.trim()) {
                    answers[input.id] = input.value.trim();
                }
            });

            document.querySelectorAll('[id$="_additional"]').forEach(input => {
                if (input.value.trim()) {
                    const questionId = input.id.replace('_additional', '');
                    if (!answers[questionId]) {
                        answers[questionId] = [];
                    }
                    const additionalValues = input.value.split(',').map(v => v.trim()).filter(v => v);
                    answers[questionId] = [...(answers[questionId] || []), ...additionalValues];
                }
            });
        }

        function checkFormValidity() {
            const inputs = document.querySelectorAll('.form-input[data-required], .form-textarea[data-required]');
            let isValid = true;
            
            inputs.forEach(input => {
                // 숨겨진 질문은 검증하지 않음
                const questionDiv = input.closest('.form-group');
                if (questionDiv && questionDiv.style.display === 'none') {
                    return;
                }
                
                if (!validateInput(input)) {
                    isValid = false;
                }
            });
            
            return isValid;
        }

        function reviewAnswers() {
            collectAllAnswers();
            
            if (!checkFormValidity()) {
                showNotification('필수 입력 항목을 모두 작성해주세요.', 'error');
                return;
            }
            
            document.getElementById('questionSection').classList.remove('active');
            document.getElementById('reviewSection').classList.add('active');
            
            updateStepNavigation(3);
            
            const reviewContent = document.getElementById('reviewContent');
            let questions;
            
            if (selectedCategory === 'missing') {
                questions = missingChildQuestions;
            } else if (selectedCategory === 'separated') {
                questions = separatedFamilyQuestions;
            } else {
                questions = friendQuestions;
            }
            
            let reviewHTML = '';
            
            questions.forEach((q, index) => {
                const answer = answers[q.id];
                
                // 조건부 질문이고 답변이 없으면 표시하지 않음
                if (q.conditional && (!answer || answer === '')) {
                    return;
                }
                
                let displayAnswer = '입력되지 않음';
                
                if (answer) {
                    if (Array.isArray(answer)) {
                        displayAnswer = answer.join(', ');
                    } else {
                        displayAnswer = answer;
                    }
                }
                
                reviewHTML += `
                    <div class="review-item fade-in" style="animation-delay: ${index * 0.1}s">
                        <div class="review-question">${q.question}</div>
                        <div class="review-answer" id="review_${q.id}">${displayAnswer}</div>
                        <button class="edit-btn" onclick="editAnswer('${q.id}', '${q.question}', '${q.type}')">수정</button>
                    </div>
                `;
            });
            
            reviewContent.innerHTML = reviewHTML;
            showNotification('입력 내용을 확인해주세요!', 'success');
        }

        function editAnswer(questionId, questionText, questionType) {
            const currentAnswer = answers[questionId];
            let newAnswer;
            
            if (questionType === 'textarea') {
                newAnswer = prompt(`${questionText}\n\n현재 답변: ${currentAnswer || '없음'}`, currentAnswer || '');
            } else {
                newAnswer = prompt(`${questionText}\n\n현재 답변: ${currentAnswer || '없음'}\n여러 개인 경우 쉼표(,)로 구분해주세요.`, 
                    Array.isArray(currentAnswer) ? currentAnswer.join(', ') : (currentAnswer || ''));
            }
            
            if (newAnswer !== null) {
                if (questionType === 'tags' && newAnswer.includes(',')) {
                    answers[questionId] = newAnswer.split(',').map(item => item.trim()).filter(item => item);
                } else {
                    answers[questionId] = newAnswer.trim();
                }
                
                const reviewElement = document.getElementById(`review_${questionId}`);
                if (reviewElement) {
                    const displayAnswer = Array.isArray(answers[questionId]) ? 
                        answers[questionId].join(', ') : 
                        (answers[questionId] || '입력되지 않음');
                    reviewElement.textContent = displayAnswer;
                    
                    reviewElement.style.background = '#e8f5e8';
                    setTimeout(() => {
                        reviewElement.style.background = '';
                    }, 1000);
                }
                
                showNotification('답변이 수정되었습니다!', 'success');
            }
        }

        function goBackToQuestions() {
            document.getElementById('reviewSection').classList.remove('active');
            document.getElementById('questionSection').classList.add('active');
            updateStepNavigation(2);
        }

        function startMatching() {
            collectAllAnswers();
            
            if (!checkFormValidity()) {
                showNotification('필수 입력 항목을 모두 작성해주세요.', 'error');
                return;
            }
            
            console.log('수집된 답변:', answers);
            proceedToMatching();
        }

        function proceedToMatching() {
            document.getElementById('reviewSection').classList.remove('active');
            
            const btn = document.getElementById('startMatchingBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span style="display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite;"></span> 매칭 중...';
            btn.disabled = true;
            
            showLoading('답변을 저장하고 매칭을 진행하고 있습니다...', '최적의 매칭을 찾는 중입니다');
            
            // 데모용 매칭 프로세스
            let progress = 60;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 95) progress = 95;
                updateProgress(progress);
            }, 300);
            
            setTimeout(() => {
                clearInterval(progressInterval);
                updateProgress(100);
                hideLoading();
                showMatchingResults();
                btn.innerHTML = originalText;
                btn.disabled = false;
                updateStepNavigation(4);
                showNotification('매칭이 완료되었습니다!', 'success');
            }, 2000);
        }

        function showMatchingResults() {
            document.getElementById('questionSection').classList.remove('active');
            document.getElementById('matchingResults').classList.add('active');
            
            const matchList = document.getElementById('matchList');
            
            if (selectedCategory === 'missing') {
                matchList.innerHTML = `
                    <div class="match-item fade-in" onclick="showComparison('김○○', 1)" style="animation-delay: 0.1s">
                        <div class="match-info">
                            <div class="match-name">김○○</div>
                            <div class="match-details">비슷한 시기, 비슷한 지역 • 집 구조 일치</div>
                        </div>
                        <div class="match-percentage">87%</div>
                    </div>
                    <div class="match-item fade-in" onclick="showComparison('이○○', 2)" style="animation-delay: 0.2s">
                        <div class="match-info">
                            <div class="match-name">이○○</div>
                            <div class="match-details">마당 특징 일치 • 근처 장소 유사</div>
                        </div>
                        <div class="match-percentage">73%</div>
                    </div>
                `;
            } else if (selectedCategory === 'separated') {
                matchList.innerHTML = `
                    <div class="match-item fade-in" onclick="showComparison('박○○', 1)" style="animation-delay: 0.1s">
                        <div class="match-info">
                            <div class="match-name">박○○</div>
                            <div class="match-details">같은 본관, 같은 고향 • 헤어진 시기 일치</div>
                        </div>
                        <div class="match-percentage">94%</div>
                    </div>
                    <div class="match-item fade-in" onclick="showComparison('최○○', 2)" style="animation-delay: 0.2s">
                        <div class="match-info">
                            <div class="match-name">최○○</div>
                            <div class="match-details">북한 지역 일치 • 남한 정착지 근접</div>
                        </div>
                        <div class="match-percentage">82%</div>
                    </div>
                `;
            } else if (selectedCategory === 'friends') {
                matchList.innerHTML = `
                    <div class="match-item fade-in" onclick="showComparison('최○○', 1)" style="animation-delay: 0.1s">
                        <div class="match-info">
                            <div class="match-name">최○○</div>
                            <div class="match-details">같은 학교, 같은 시기 • 동네 근접</div>
                        </div>
                        <div class="match-percentage">91%</div>
                    </div>
                    <div class="match-item fade-in" onclick="showComparison('정○○', 2)" style="animation-delay: 0.2s">
                        <div class="match-info">
                            <div class="match-name">정○○</div>
                            <div class="match-details">비슷한 별명 • 친구 특징 일치</div>
                        </div>
                        <div class="match-percentage">78%</div>
                    </div>
                `;
            }
        }

        function showComparison(partnerName, partnerId) {
            currentPartner = { name: partnerName, id: partnerId };
            
            document.getElementById('matchingResults').classList.remove('active');
            document.getElementById('comparisonSection').classList.add('active');
            
            const content = document.getElementById('comparisonContent');
            let comparisonHTML = '';
            
            // 샘플 비교 데이터
            let currentSample, partnerSample, questions;
            
            if (selectedCategory === 'missing') {
                currentSample = sampleAnswers.missing;
                partnerSample = { ...sampleAnswers.missing, doorColor: ['초록색'], houseType: ['양옥'] };
                questions = missingChildQuestions;
            } else if (selectedCategory === 'separated') {
                currentSample = sampleAnswers.separated;
                partnerSample = { ...sampleAnswers.separated, familyClan: '전주이씨', hometown: '함경남도 흥남시' };
                questions = separatedFamilyQuestions;
            } else {
                currentSample = sampleAnswers.friends;
                partnerSample = { ...sampleAnswers.friends, friendType: ['고등학교'], gender: ['동성'] };
                questions = friendQuestions;
            }
            
            // 주요 질문들만 비교 표시 (처음 10개)
            questions.slice(0, 10).forEach((q, index) => {
                const myAnswer = answers[q.id] || currentSample[q.id] || '정보 없음';
                const partnerAnswer = partnerSample[q.id] || '정보 없음';
                
                const myAnswerStr = Array.isArray(myAnswer) ? myAnswer.join(', ') : myAnswer;
                const partnerAnswerStr = Array.isArray(partnerAnswer) ? partnerAnswer.join(', ') : partnerAnswer;
                
                // 간단한 매칭 로직
                let matchClass = '';
                let matchIndicator = '';
                
                if (myAnswerStr === partnerAnswerStr) {
                    matchClass = 'exact-match';
                    matchIndicator = '<span class="match-indicator exact-indicator">정확 일치</span>';
                } else if (myAnswerStr !== '정보 없음' && partnerAnswerStr !== '정보 없음') {
                    matchClass = 'similar-match';
                    matchIndicator = '<span class="match-indicator similar-indicator">유사 일치</span>';
                }
                
                comparisonHTML += `
                    <div class="comparison-item ${matchClass} fade-in" style="animation-delay: ${index * 0.1}s">
                        <div class="question-title">${q.question} ${matchIndicator}</div>
                        <div class="answer-comparison">
                            <div class="my-answer-section">
                                <div class="answer-label my-answer-label">나의 답변</div>
                                <div class="answer-content my-answer">${myAnswerStr}</div>
                            </div>
                            <div class="partner-answer-section">
                                <div class="answer-label partner-answer-label">${currentPartner.name}님의 답변</div>
                                <div class="answer-content partner-answer">${partnerAnswerStr}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = comparisonHTML;
            showNotification('상세 비교 정보를 확인해보세요!', 'success');
        }

        function goBackToMatching() {
            document.getElementById('comparisonSection').classList.remove('active');
            document.getElementById('matchingResults').classList.add('active');
        }

        function proceedToChat() {
            document.getElementById('comparisonSection').classList.remove('active');
            document.getElementById('chatRoom').classList.add('active');
            document.getElementById('chatPartnerName').textContent = `${currentPartner.name}님과의 대화`;
            
            updateStepNavigation(5);
            
            // 데모 채팅 시작
            startDemoChat();
            
            showNotification('실시간 채팅방에 입장했습니다!', 'success');
        }

        function startDemoChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            setTimeout(() => {
                displayMessage('안녕하세요! 매칭되어서 연락드립니다. 혹시 저를 기억하시나요?', currentPartner.name, 'received');
            }, 1000);
        }

        function displayMessage(text, sender, type) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type} fade-in`;
            
            if (type === 'received') {
                messageDiv.innerHTML = `<div style="font-size: 0.8rem; color: #999; margin-bottom: 3px;">${sender}</div>${text}`;
            } else {
                messageDiv.textContent = text;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) {
                showNotification('메시지를 입력해주세요.', 'warning');
                return;
            }
            
            displayMessage(message, currentUser.nickname, 'sent');
            input.value = '';
            
            // 데모 자동 응답
            setTimeout(() => {
                const responses = [
                    "네, 맞습니다! 정말 반가워요! 😊",
                    "그때 정말 재미있었는데... 기억나시나요?",
                    "와, 이렇게 다시 만나다니! 정말 신기해요!",
                    "정말 오랜만이에요! 어떻게 지내셨어요?",
                    "이렇게 찾아주셔서 정말 감사해요! 🙏"
                ];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                displayMessage(randomResponse, currentPartner.name, 'received');
            }, 1000 + Math.random() * 2000);
        }

        function goBackToCategory() {
            // 현재 섹션 숨기기
            document.getElementById('questionSection').classList.remove('active');
            document.getElementById('questionSection').classList.add('hidden');
            document.getElementById('reviewSection').classList.remove('active');
            document.getElementById('matchingResults').classList.remove('active');
            document.getElementById('comparisonSection').classList.remove('active');
            document.getElementById('chatRoom').classList.remove('active');
            
            // 카테고리 바 숨기기
            document.getElementById('currentCategoryBar').style.display = 'none';
            
            // 카테고리 선택으로 돌아가기
            document.getElementById('mainCategorySection').classList.remove('hidden');
            
            // 스텝과 진행률 초기화
            updateStepNavigation(1);
            updateProgress(20);
            
            // 선택 상태 초기화
            selectedCategory = '';
            selectedSubCategory = '';
            answers = {};
            
            // 카테고리 선택 해제
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 배너 숨기기
            document.getElementById('consultationBanner').style.display = 'none';
            
            showNotification('카테고리 선택으로 돌아갑니다', 'success');
        }

        function initBackgroundAnimation() {
            const bgAnimation = document.getElementById('bgAnimation');
            const memories = ['💭', '❤️', '🌟', '📚', '🎵', '⚽', '🎮', '✨', '🌈', '💫', '🎯', '🔍', '💡', '🏠', '👨‍👩‍👧‍👦', '🎪'];
            
            setInterval(() => {
                const memory = document.createElement('div');
                memory.className = 'floating-memory';
                memory.textContent = memories[Math.floor(Math.random() * memories.length)];
                memory.style.left = Math.random() * 100 + '%';
                memory.style.animationDelay = Math.random() * 2 + 's';
                memory.style.animationDuration = (15 + Math.random() * 10) + 's';
                
                bgAnimation.appendChild(memory);
                
                setTimeout(() => {
                    if (memory.parentNode) {
                        memory.parentNode.removeChild(memory);
                    }
                }, 25000);
            }, 3000);
        }

        // 키보드 단축키
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                const currentSection = document.querySelector('.question-section.active, .review-section.active');
                if (currentSection) {
                    if (currentSection.id === 'questionSection') {
                        reviewAnswers();
                    } else if (currentSection.id === 'reviewSection') {
                        proceedToMatching();
                    }
                }
            }
        });

        // 앱 초기화
        window.addEventListener('load', function() {
            initBackgroundAnimation();
            initFirebase();
            initKakao();
            initSocket();
            
            document.body.style.opacity = '0';
            setTimeout(() => {
                document.body.style.transition = 'opacity 0.5s ease';
                document.body.style.opacity = '1';
            }, 100);
        });
    </script>
</body>
</html>
